<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - STM-ADV</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css'>

    <style>
        /* PADRÕES STM-ADV (ESTILOS COPIADOS) */
        :root {
            --primary-color: #2c3e50; /* Cinza Escuro (Sidebar/Header/Title) */
            --secondary-color: #34495e; /* Cinza Escuro 2 */
            --accent-color: #3498db; /* Azul */
            --light-bg: #f8f9fa;
            --bs-body-bg: var(--light-bg);
            /* Gradientes para os novos Cards */
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        .main-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1030;
            height: 56px;
        }
        .navbar-brand img { height: 35px; filter: brightness(0) invert(1); margin-top: -3px; }
        .navbar-brand span { font-weight: 600; font-size: 1.3rem; margin-left: 0.5rem; }

        .sidebar {
            background-color: var(--primary-color);
            box-shadow: 2px 0 6px rgba(0,0,0,0.1);
            padding-top: 1rem;
            width: 250px;
            position: fixed;
            top: 56px;
            bottom: 0;
            overflow-y: auto;
            z-index: 1020;
            display: flex;
            flex-direction: column;
            transition: left 0.3s ease-in-out;
        }
        .sidebar a.nav-link { color: rgba(255, 255, 255, 0.75); padding: 0.8rem 1.5rem; border-left: 4px solid transparent; }
        .sidebar a.nav-link:hover { background-color: rgba(255, 255, 255, 0.08); color: white; border-left-color: var(--accent-color); }
        .sidebar a.nav-link.active { background-color: rgba(52, 152, 219, 0.15); color: white; border-left-color: var(--accent-color); }

        .content-wrapper {
            margin-left: 250px;
            padding: 2rem;
            flex-grow: 1;
        }

        .main-footer {
            background-color: #ffffff;
            color: var(--primary-color);
            padding: 1rem 0;
            margin-top: auto;
            width: 100%;
            border-top: 1px solid #dee2e6;
            font-size: 0.85rem;
        }
        @media (min-width: 993px) {
            .main-footer .container-fluid { padding-left: 270px; }
        }

        .page-title { color: var(--primary-color); font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; font-size: 1.8rem; }
        .page-title i { margin-right: 0.75rem; font-size: 1.6rem; color: var(--secondary-color); }

        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; margin-bottom: 1.5rem; }
        .card:hover { transform: translateY(-2px); }

        .bg-gradient-success { background-image: linear-gradient(310deg, #2dce89, #2ecc71); }
        .bg-gradient-info { background-image: linear-gradient(310deg, #11c1e0, #3498db); }
        .bg-gradient-danger { background-image: linear-gradient(310deg, #f5365c, #e74c3c); }

        .icon-shape { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background-color: white; color: var(--primary-color); text-align: center; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 1.5rem; }

        #calendar { max-width: 100%; }
        .btn-acao-agenda { padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border-radius: 0.5rem; }
        .evento-item { border-left: 4px solid var(--accent-color); padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 0.5rem; background-color: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .evento-item small { font-size: 0.8rem; color: #6c757d; }
    </style>
</head>
<body>

<header class="main-header">
    <nav class="navbar navbar-expand-lg navbar-dark px-3">
        <button class="navbar-toggler me-3" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <a class="navbar-brand d-flex align-items-center me-auto" href="/">
            <img src="/assets/img/logo.png" alt="Logo STM-ADV" class="me-2">
            <span>STM-ADV</span>
        </a>

        <div class="navbar-nav align-items-center">
            <span class="nav-link text-white me-3 d-none d-lg-block">
                {#if usuario.perfil}
                <span class="badge bg-info text-white ms-1 text-uppercase me-2">{usuario.perfil}</span>
                {/if}
                <i class="bi bi-person-circle me-1"></i>
                {#if usuario}
                    {usuario.nome ?: 'Usuário'}
                {#else}
                    <span>Carregando...</span>
                {/if}
            </span>
        </div>
    </nav>
</header>

<div class="d-flex flex-grow-1">
    <aside class="sidebar collapse d-lg-block" id="sidebarNav">
        <nav class="nav flex-column">
            <a href="{#if usuario.perfil == 'MASTER'}/dashboard/master{#else if usuario.perfil == 'ADVOGADO'}/dashboard{#else}/dashboard-cliente{/if}" class="nav-link">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>

            {#if usuario.perfil == 'MASTER' || usuario.perfil == 'ADVOGADO'}
            <a href="/clientes" class="nav-link">
                <i class="bi bi-people-fill"></i> Clientes
            </a>
            <a href="/processos" class="nav-link">
                <i class="bi bi-folder2-open"></i> Processos
            </a>
            <a href="/agenda" class="nav-link active">
                <i class="bi bi-calendar-event"></i> Agenda
            </a>
            {/if}

            {#if usuario.perfil == 'MASTER'}
            <a href="/gestao-usuarios" class="nav-link">
                <i class="bi bi-person-gear"></i> Gestão Usuários
            </a>
            <a href="/auditoria" class="nav-link">
                <i class="bi bi-shield-lock"></i> Auditoria
            </a>
            {/if}

            <a href="/video-chamada" class="nav-link">
                <i class="bi bi-camera-video"></i> Vídeo Chamada
            </a>
        </nav>

        <div class="mt-auto">
            <hr class="mx-3">
            <a href="/perfil" class="nav-link">
                <i class="bi bi-person-gear"></i> Meu Perfil
            </a>
            <a href="#" class="nav-link" onclick="fazerLogout(); return false;">
                <i class="bi bi-box-arrow-right"></i> Sair
            </a>
        </div>
    </aside>

    <div class="sidebar-overlay d-lg-none" data-bs-toggle="collapse" data-bs-target="#sidebarNav"></div>

    <main class="content-wrapper">
        <h1 class="page-title">
            Agenda e Compromissos
        </h1>
        <div class="container-fluid py-0 px-0">
            <div class="row g-4 mb-4">
                <div class="col-lg-4 col-md-6">
                    <div class="card p-3 shadow-sm bg-gradient-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start">
                                <p class="text-sm mb-0 text-white opacity-7">Compromissos Hoje</p>
                                <h5 class="font-weight-bolder text-white mb-0" id="compromissosHoje">0</h5>
                            </div>
                            <div class="icon icon-shape text-dark text-center rounded-circle">
                                <i class="bi bi-calendar-check opacity-10"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="card p-3 shadow-sm bg-gradient-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start">
                                <p class="text-sm mb-0 text-white opacity-7">Compromissos 7 dias</p>
                                <h5 class="font-weight-bolder text-white mb-0" id="compromissosSemana">0</h5>
                            </div>
                            <div class="icon icon-shape text-dark text-center rounded-circle">
                                <i class="bi bi-calendar-week opacity-10"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-12">
                    <div class="card p-3 shadow-sm bg-gradient-danger text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start">
                                <p class="text-sm mb-0 text-white opacity-7">Próximas Audiências</p>
                                <h5 class="font-weight-bolder text-white mb-0" id="audiencias">0</h5>
                            </div>
                            <div class="icon icon-shape text-dark text-center rounded-circle">
                                <i class="bi bi-mic opacity-10"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12 text-end">
                    <button class="btn btn-primary shadow-sm btn-acao-agenda" data-bs-toggle="modal" data-bs-target="#modalNovoEvento">
                        <i class="bi bi-plus-circle me-2"></i> Adicionar Novo Compromisso
                    </button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-9">
                    <div class="card shadow-sm p-4">
                        <div id='calendar'></div>
                    </div>
                </div>

                <div class="col-lg-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-header">
                            <i class="bi bi-list-task me-1"></i> Próximos 5 Eventos
                        </div>
                        <div class="card-body p-3" id="proximosEventosList">
                            <p class="text-muted small text-center mt-3" id="loadingEventsMessage">
                                Carregando eventos...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalNovoEvento" tabindex="-1" aria-labelledby="modalNovoEventoLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNovoEventoLabel">Criar Novo Compromisso</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="formEvento">
                        <div class="modal-body">
                            <input type="hidden" id="eventoId" name="id">
                            <div class="mb-3">
                                <label for="tituloEvento" class="form-label">Título</label>
                                <input type="text" class="form-control" id="tituloEvento" name="titulo" required>
                            </div>
                            <div class="mb-3">
                                <label for="descricaoEvento" class="form-label">Descrição</label>
                                <textarea class="form-control" id="descricaoEvento" name="descricao"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="dataInicio" class="form-label">Início</label>
                                    <input type="datetime-local" class="form-control" id="dataInicio" name="dataInicio" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="dataFim" class="form-label">Fim</label>
                                    <input type="datetime-local" class="form-control" id="dataFim" name="dataFim">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="corEvento" class="form-label">Cor</label>
                                    <input type="color" class="form-control form-control-color" id="corEvento" name="cor" value="#007bff">
                                </div>
                                <div class="col-md-6 mb-3 d-flex align-items-end">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allDay" name="diaInteiro">
                                        <label class="form-check-label" for="allDay">
                                            Dia inteiro
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger me-auto" id="btnDeletarEvento" onclick="deletarEvento()" style="display: none;">Deletar</button>

                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <button type="submit" class="btn btn-primary" id="btnSalvarEvento">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>

<footer class="main-footer mt-auto">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
                <p class="mb-0 small">&copy; <span id="footerYear">2024</span> STM-ADV. Todos os direitos reservados.</p>
            </div>
            <div class="col-md-6 text-center text-md-end">
                <a href="/sobre" class="me-3 small">Sobre</a>
                <a href="/contato" class="me-3 small">Contato</a>
                <a href="/privacidade" class="small">Privacidade</a>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js'></script>

<script>
    function fazerLogout() {
        if (!confirm('Deseja realmente sair do sistema?')) return;
        document.cookie = "token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebarNav');
        const overlay = document.querySelector('.sidebar-overlay');

        if (sidebar && overlay) {
            sidebar.addEventListener('show.bs.collapse', () => overlay.style.display = 'block');
            sidebar.addEventListener('hide.bs.collapse', () => overlay.style.display = 'none');
            overlay.addEventListener('click', () => {
                const bsCollapse = bootstrap.Collapse.getInstance(sidebar);
                if (bsCollapse) bsCollapse.hide();
            });
        }
        document.getElementById('footerYear').textContent = new Date().getFullYear();
    });

    // ------------------------------
    // CARREGAR EVENTOS DO QUTE
    // ------------------------------
    const eventosCarregados = [
        {#for ev in eventos}
        {
            id: {ev.id},
            title: "{ev.titulo:js}",
            start: "{ev.dataInicio}",
            // CORREÇÃO CRÍTICA: Uso do operador ternário da EL para evitar erro de parser
            // Injeta a string de data entre aspas ou 'null' (literal JS)
            end: {ev.dataFim ? ('"' + ev.dataFim + '"') : 'null'},
            color: "{ev.cor}",
            allDay: {ev.diaInteiro},
            description: "{ev.descricao:js}"
        }{#if hasNext},{/if}
        {/for}
    ];

            // Corrige "null" string para null literal e garante que description não seja null
            const eventosCorrigidos = eventosCarregados.map(e => {
                if (e.end === "null" || e.end === "") e.end = null;
                e.description = e.description ?? "";
                return e;
            });

            // ------------------------------
            // Inicialização do Calendário
            // ------------------------------
            document.addEventListener('DOMContentLoaded', function() {

                const calendarEl = document.getElementById('calendar');

                if (!calendarEl) {
                    console.error("Elemento 'calendar' não encontrado. Verifique o ID no HTML.");
                    return;
                }

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'pt-br',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                    },
                    events: eventosCorrigidos,
                    editable: true,
                    selectable: true,
                    eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false },

                    select: function(info) { abrirModalNovo(info.startStr, info.endStr, info.allDay); },
                    eventClick: function(info) { abrirEdicaoEvento(info.event.id); },
                    eventChange: function(info) {
                        // Aqui você pode adicionar a lógica para salvar arrastar/soltar ou resize
                        console.log("Evento alterado. Implementar fetch de update aqui.");
                    }
                });

                calendar.render();

                atualizarEstatisticas(eventosCorrigidos);
                preencherProximosEventos(eventosCorrigidos);
            });

            // ------------------------------
            // Funções de Utilitários
            // ------------------------------
            const formatadorData = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

            function preencherProximosEventos(eventos) {
                const listaEl = document.getElementById('proximosEventosList');
                const agora = new Date();

                const eventosFuturos = eventos
                    .filter(e => new Date(e.start) >= agora)
                    .sort((a, b) => new Date(a.start) - new Date(b.start));

                listaEl.innerHTML = '';

                if (eventosFuturos.length === 0) {
                    listaEl.innerHTML = '<p class="text-muted small text-center mt-3">Nenhum evento futuro encontrado.</p>';
                    return;
                }

                eventosFuturos.slice(0, 5).forEach(e => {
                    const dataHora = formatadorData.format(new Date(e.start));
                    const item = document.createElement('div');
                    item.className = 'evento-item';
                    item.style.borderLeftColor = e.color;

                    item.innerHTML = `
                <strong class="d-block text-truncate">${e.title}</strong>
                <small>
                    <i class="bi bi-clock me-1"></i> ${dataHora}
                </small>
            `;
                    listaEl.appendChild(item);
                });
            }

            // ------------------------------
            // Estatísticas do Dashboard
            // ------------------------------
            function atualizarEstatisticas(eventos) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);

                const compromissosHoje = eventos.filter(e => {
                    const dataEvento = new Date(e.start);
                    return dataEvento.toDateString() === hoje.toDateString();
                }).length;

                const proximos7Dias = new Date(hoje.getTime() + 7 * 86400000);

                const compromissosSemana = eventos.filter(e => {
                    const d = new Date(e.start);
                    return d >= hoje && d <= proximos7Dias;
                }).length;

                const audiencias = eventos.filter(e =>
                    e.title.toLowerCase().includes("audiência") && new Date(e.start) > new Date()
                ).length;

                document.getElementById("compromissosHoje").textContent = compromissosHoje;
                document.getElementById("compromissosSemana").textContent = compromissosSemana;
                document.getElementById("audiencias").textContent = audiencias;
            }


            // ------------------------------
            // MODAL / FORMULÁRIO GESTÃO
            // ------------------------------
            const eventoModal = new bootstrap.Modal(document.getElementById('modalNovoEvento'));
            const btnDeletar = document.getElementById('btnDeletarEvento');

            document.getElementById('modalNovoEvento').addEventListener('hidden.bs.modal', function () {
                document.getElementById('formEvento').reset();
                document.getElementById('eventoId').value = "";
                document.getElementById('modalNovoEventoLabel').textContent = "Criar Novo Compromisso";

                // Esconde o botão de deletar ao fechar
                if (btnDeletar) btnDeletar.style.display = 'none';
            });

            function formatFullCalendarDate(d) {
                if (!d || d === "null") return "";
                return d.substring(0, 16);
            }

            function abrirModalNovo(start, end, allDay) {
                document.getElementById('modalNovoEventoLabel').textContent = "Criar Novo Compromisso";

                document.getElementById('eventoId').value = "";
                document.getElementById('tituloEvento').value = "";
                document.getElementById('descricaoEvento').value = "";
                document.getElementById('corEvento').value = "#007bff";

                document.getElementById('dataInicio').value = formatFullCalendarDate(start);
                document.getElementById('dataFim').value = formatFullCalendarDate(end);
                document.getElementById('allDay').checked = allDay;

                if (btnDeletar) btnDeletar.style.display = 'none';

                eventoModal.show();
            }

            function abrirEdicaoEvento(id) {
                const ev = eventosCorrigidos.find(e => e.id == id);
                if (!ev) return alert("Evento não encontrado!");

                document.getElementById('modalNovoEventoLabel').textContent = "Editar Compromisso: " + ev.title;

                document.getElementById('eventoId').value = ev.id;
                document.getElementById('tituloEvento').value = ev.title;
                document.getElementById('descricaoEvento').value = ev.description ?? "";
                document.getElementById('dataInicio').value = formatFullCalendarDate(ev.start);
                document.getElementById('dataFim').value = formatFullCalendarDate(ev.end);
                document.getElementById('corEvento').value = ev.color;
                document.getElementById('allDay').checked = ev.allDay;

                // Mostra o botão de deletar na edição
                if (btnDeletar) btnDeletar.style.display = 'inline-block';

                eventoModal.show();
            }

            // ------------------------------
            // DELETAR EVENTO (IMPLEMENTAÇÃO REAL VIA FETCH)
            // ------------------------------
            function deletarEvento() {
                const id = document.getElementById('eventoId').value;
                if (!id || !confirm('Tem certeza que deseja deletar este compromisso?')) return;

                fetch(`/agenda/evento/${id}`, {
                    method: 'DELETE',
                })
                    .then(response => {
                        if (response.status === 204) { // 204 No Content = sucesso
                            alert("Evento deletado com sucesso.");
                            eventoModal.hide();
                            window.location.reload();
                        } else if (response.status === 403) {
                            alert("Erro: Você não tem permissão para deletar este evento.");
                        } else {
                            alert(`Erro ${response.status}: Falha ao deletar o evento.`);
                        }
                    })
                    .catch(error => {
                        console.error('Erro de deleção:', error);
                        alert(`Erro de comunicação ao deletar evento: ${error.message}`);
                    });
            }


            // ------------------------------
            // SALVAR EVENTO (IMPLEMENTAÇÃO REAL VIA FETCH)
            // ------------------------------
            document.getElementById("formEvento").addEventListener("submit", function (event) {
                event.preventDefault();

                const form = this;
                const btn = document.getElementById("btnSalvarEvento");
                const isEditing = document.getElementById('eventoId').value !== "";

                btn.disabled = true;
                btn.innerHTML = "<span class='spinner-border spinner-border-sm'></span> Salvando...";

                const formData = {
                    id: isEditing ? parseInt(form.elements.id.value) : null,
                    titulo: form.elements.titulo.value,
                    descricao: form.elements.descricao.value,
                    dataInicio: form.elements.dataInicio.value,
                    dataFim: form.elements.dataFim.value || null,
                    cor: form.elements.cor.value,
                    diaInteiro: form.elements.diaInteiro.checked,
                };

                fetch('/agenda/evento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                })
                    .then(response => {
                        if (!response.ok) {
                            const status = response.status;
                            if (status === 403) {
                                throw new Error('Você não tem permissão para editar/criar este evento.');
                            }
                            throw new Error(`Erro ${status}: Falha ao salvar o evento.`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert("Evento salvo com sucesso.");
                        eventoModal.hide();
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Erro de salvamento:', error);
                        alert(`Erro ao salvar evento: ${error.message}`);
                    })
                    .finally(() => {
                        btn.disabled = false;
                        btn.innerHTML = "Salvar";
                    });
            });
</script>

</body>
</html>